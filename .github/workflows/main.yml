name: Build Android AAB

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Setup Java 21
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Create web assets for Capacitor
      run: |
        mkdir -p dist/public
        mkdir -p www
        cat > dist/public/index.html << 'HTMLEOF'
        <!DOCTYPE html>
        <html>
        <head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
        <title>SaveZar</title>
        <style>body{margin:0;background:#DC2626;display:flex;align-items:center;justify-content:center;height:100vh;font-family:sans-serif;color:white;}
        .loader{text-align:center;}.spinner{border:4px solid rgba(255,255,255,0.3);border-top:4px solid white;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:0 auto 16px;}
        @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}</style>
        </head>
        <body><div class="loader"><div class="spinner"></div><p>Connecting to SaveZar...</p></div>
        <script>setTimeout(function(){window.location.href='https://savezar.com';},3000);</script>
        </body></html>
        HTMLEOF
        cp dist/public/index.html www/index.html
        
    - name: Sync Capacitor
      run: npx cap sync android
      
    - name: Restore Capacitor server config
      run: |
        cat > android/app/src/main/assets/capacitor.config.json << 'EOF'
        {
          "appId": "com.savezar.taxi",
          "appName": "SaveZar",
          "webDir": "dist/public",
          "server": {
            "androidScheme": "https",
            "url": "https://savezar.com",
            "cleartext": false,
            "allowNavigation": ["savezar.com", "*.savezar.com", "*.replit.dev", "*.replit.app"]
          },
          "plugins": {
            "SplashScreen": {
              "launchShowDuration": 2000,
              "backgroundColor": "#DC2626",
              "androidSplashResourceName": "splash",
              "showSpinner": false
            }
          },
          "android": {
            "backgroundColor": "#DC2626"
          }
        }
        EOF
      
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Decode Keystore
      run: |
        echo "${{ secrets.RELEASE_KEYSTORE }}" | base64 -d > android/app/release-keystore.jks
        
    - name: Build AAB
      working-directory: android
      run: |
        chmod +x gradlew
        ./gradlew bundleRelease \
          -Pandroid.injected.signing.store.file=${{ github.workspace }}/android/app/release-keystore.jks \
          -Pandroid.injected.signing.store.password=${{ secrets.RELEASE_KEYSTORE_PASSWORD }} \
          -Pandroid.injected.signing.key.alias=${{ secrets.RELEASE_KEY_ALIAS }} \
          -Pandroid.injected.signing.key.password=${{ secrets.RELEASE_KEY_PASSWORD }}
          
    - name: Upload AAB Artifact
      uses: actions/upload-artifact@v4
      with:
        name: savezar-release
        path: android/app/build/outputs/bundle/release/app-release.aab
        retention-days: 30
